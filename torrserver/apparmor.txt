#include <tunables/global>

profile torrserver flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/ssl_certs>

  # --- Parent Process (S6-Overlay + Bashio + run.sh) ---

  # S6-Overlay entrypoint
  /init rix,
  /run.sh rix,

  # System binaries required for initialization scripts and Bashio
  /bin/** rix,
  /usr/bin/** rix,
  /sbin/** rix,
  /usr/sbin/** rix,

  # S6-Overlay v3 specific binary paths
  /package/** rix,
  /command/** rix,
  /libexec/** rix,
  /usr/lib/bashio/** rix,

  # Runtime directory access
  # S6 generates and executes scripts in /run during startup (requires write + execute)
  /run/ rwk,
  /run/** rwkix,
  /var/run/ rwk,
  /var/run/** rwkix,

  # Service definitions and overlay configurations
  /etc/services.d/** rix,
  /etc/cont-init.d/** rix,
  /etc/s6-overlay/** rix,

  # Persistent storage access
  /data/** rw,
  /config/** rwk,
  /share/** rw,

  # Temporary files and standard devices
  /tmp/** rwk,
  /dev/tty rw,
  /dev/console rw,
  /dev/null rw,
  /dev/zero rw,
  /dev/random rw,
  /dev/urandom rw,
  /dev/ptmx rw,
  /dev/pts/* rw,

  # --- Profile Transition ---
  # Transition to a confined profile when the main binary is executed
  /usr/bin/torrserver cx -> torrserver_bin,

  # --- Child Process (TorrServer Binary) ---
  profile torrserver_bin flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/ssl_certs>

    # Network access for BitTorrent and WebUI
    network,

    # Allow receiving control signals from the parent process
    signal (receive) peer=torrserver,

    # Application specific storage access
    /config/** rwk,
    /share/** rw,
    /data/** rw,
    /tmp/** rwk,

    # Allow the binary to read itself
    /usr/bin/torrserver r,

    # Go runtime system requirements
    /proc/self/status r,
    /sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
    /proc/sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
    /sys/devices/system/cpu/** r,

    # Logging
    /dev/stdout rw,
    /dev/stderr rw,
    /dev/tty rw,
  }
}
