#include <tunables/global>

profile torrserver flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/ssl_certs>

  # --- [ PARENT PROCESS (S6 + Bashio + System) ] ---

  # 1. Entrypoint & S6 Core
  /init rix,

  # 2. System binaries (Standard)
  /bin/** rix,
  /usr/bin/** rix,
  /sbin/** rix,
  /usr/sbin/** rix,

  # 3. S6-Overlay & Bashio
  /package/** rix,
  /command/** rix,
  /libexec/** rix,
  /usr/lib/bashio/** rix,

  # 4. Runtime & Service definitions
  /run/** rix,
  /etc/services.d/** rix,
  /etc/cont-init.d/** rix,
  /etc/s6-overlay/** rix,

  # 5. Storage Access
  /data/** rw,
  /config/** rwk,
  /share/** rw,

  # 6. Temp files & terminal
  /tmp/** rwk,
  /dev/tty rw,
  /dev/console rw,

  # --- [ PROFILE TRANSITION ] ---
  # Only restrict the actual TorrServer binary
  /usr/bin/torrserver cx -> torrserver_bin,

  # --- [ CHILD PROCESS (TorrServer) ] ---
  profile torrserver_bin flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/ssl_certs>

    # Network
    network,

    # Signals
    signal (receive) peer=torrserver,

    # Data Access
    /config/** rwk,
    /share/** rw,
    /data/** rw,
    /tmp/** rwk,

    # Self-read
    /usr/bin/torrserver r,

    # Go Runtime
    /proc/self/status r,
    /sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
    /proc/sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,

    # Logs
    /dev/stdout rw,
    /dev/stderr rw,
    /dev/tty rw,
  }
}
