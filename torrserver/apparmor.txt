#include <tunables/global>

profile torrserver flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/ssl_certs>

  # --- [ PARENT PROCESS (S6 + Bashio + System) ] ---

  # 1. Entrypoint & S6 Core
  /init rix,

  # 2. System binaries (Standard)
  /bin/** ix,
  /usr/bin/** ix,
  /sbin/** ix,
  /usr/sbin/** ix,

  # 3. S6-Overlay & Bashio SPECIFIC PATHS (FIX FOR YOUR ERROR)
  # S6 stores binaries in /package and symlinks them to /command
  /package/** ix,
  /command/** ix,
  /libexec/** ix,       # Location of s6-overlay-suexec
  /usr/lib/bashio/** ix,

  # 4. Runtime & Service definitions
  /run/** ix,           # Allow executing generated scripts in /run
  /etc/services.d/** rix,
  /etc/cont-init.d/** rix,
  /etc/s6-overlay/** rix,

  # 5. Storage Access
  /data/** rw,
  /config/** rwk,
  /share/** rw,
  /tmp/** rwk,
  /dev/tty rw,

  # --- [ PROFILE TRANSITION ] ---
  # Only restrict the actual TorrServer binary
  /usr/bin/torrserver cx -> torrserver_bin,

  # --- [ CHILD PROCESS (TorrServer) ] ---
  profile torrserver_bin flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/ssl_certs>

    # Network
    network,

    # Signals (FIXED SYNTAX: moved to new line)
    signal (receive) peer=torrserver,

    # Data Access
    /config/** rwk,
    /share/** rw,
    /data/** rw,
    /tmp/** rwk,

    # Self-read
    /usr/bin/torrserver r,

    # Go Runtime
    /proc/self/status r,
    /sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
    /proc/sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,

    # Logs
    /dev/stdout rw,
    /dev/stderr rw,
    /dev/tty rw,
  }
}
