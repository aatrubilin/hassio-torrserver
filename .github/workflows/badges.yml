---
name: badges

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch: {}

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Fetch downloads and generate JSON
        shell: python
        run: |
          import urllib.request
          import re
          import json
          import os

          packages = {
              "amd64": "https://github.com/users/aatrubilin/packages/container/package/hassio-torrserver%2Famd64",
              "aarch64": "https://github.com/users/aatrubilin/packages/container/package/hassio-torrserver%2Faarch64"
          }

          os.makedirs("badges", exist_ok=True)

          for arch, url in packages.items():
              print(f"Fetching {arch}...")
              req = urllib.request.Request(url, headers={"User-Agent": "Mozilla/5.0"})
              try:
                  html = urllib.request.urlopen(req).read().decode("utf-8")

                  total_match = re.search(r"Total downloads[\s\S]{1,50}?<[^>]+>([\d\.,]+[kKmM]?)<", html, re.IGNORECASE)
                  total_count = total_match.group(1).strip() if total_match else "unknown"

                  latest_match = re.search(r"</svg>\s*([\d\.,]+[kKmM]?)\s*<span class=\"sr-only\">Version downloads</span>", html, re.IGNORECASE)
                  latest_count = latest_match.group(1).strip() if latest_match else "unknown"

              except Exception as e:
                  print(f"Error fetching {url}: {e}")
                  total_count = "error"
                  latest_count = "error"

              print(f"{arch} - Total: {total_count}, Latest: {latest_count}")

              def save_badge(filename, label, count, color):
                  badge_data = {
                      "schemaVersion": 1,
                      "label": label,
                      "message": count,
                      "color": color
                  }
                  with open(f"badges/{filename}.json", "w") as f:
                      json.dump(badge_data, f)

              save_badge(arch, arch, f"{latest_count}/{total_count}", "blue")

      - name: Commit and push badges
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./badges
          publish_branch: badges
          commit_message: "chore: update download badges"
          force_orphan: true
