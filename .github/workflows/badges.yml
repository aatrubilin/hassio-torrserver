---
name: badges

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Fetch downloads and generate JSON
        shell: python
        run: |
          import urllib.request
          import re
          import json
          import os

          packages = {
              "amd64": "https://github.com/users/aatrubilin/packages/container/package/hassio-torrserver%2Famd64",
              "aarch64": "https://github.com/users/aatrubilin/packages/container/package/hassio-torrserver%2Faarch64"
          }

          os.makedirs("badges", exist_ok=True)

          for arch, url in packages.items():
              print(f"Fetching {arch}...")
              req = urllib.request.Request(url, headers={"User-Agent": "Mozilla/5.0"})
              try:
                  html = urllib.request.urlopen(req).read().decode("utf-8")
                  match = re.search(r"Total downloads[\s\S]{1,150}?([0-9\.,]+[kKmM]?)", html, re.IGNORECASE)
                  count = match.group(1).strip() if match else "unknown"
              except Exception as e:
                  print(f"Error fetching {url}: {e}")
                  count = "error"

              print(f"{arch} downloads: {count}")

              badge_data = {
                  "schemaVersion": 1,
                  "label": f"downloads {arch}",
                  "message": count,
                  "color": "blue"
              }

              with open(f"badges/{arch}.json", "w") as f:
                  json.dump(badge_data, f)

      - name: Commit and push badges
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./badges
          publish_branch: badges
          commit_message: "chore: update download badges"
          force_orphan: true
